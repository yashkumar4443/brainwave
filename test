<?php
/*
Plugin Name: Secure Form Handler Lite
Description: Adds password gate, reuses Gravity PDF file, emails internal recipients, and deletes PDF after 10 mins.
Version: 1.0
Author: Yash
*/

if ( ! defined( 'ABSPATH' ) ) exit;

/**
 * STEP 1: Password protect the form page.
 */
add_action('template_redirect', function() {

    $protected_page_slug = 'prescription-transfer-request-form'; // your page slug
    $form_password = 'test123';

    if (is_page($protected_page_slug)) {
        if (!session_id()) session_start();

        // If already unlocked, allow
        if (!empty($_SESSION['sfh_unlocked'])) return;

        // Handle password submission
        if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['sfh_password'])) {
            $entered = sanitize_text_field($_POST['sfh_password']);
            if ($entered === $form_password) {
                $_SESSION['sfh_unlocked'] = true;
                wp_safe_redirect(get_permalink());
                exit;
            } else {
                $error = '<p style="color:red;">Incorrect password.</p>';
            }
        }

        // Show password form
        get_header();
        echo '<div style="max-width:400px;margin:80px auto;padding:30px;border:1px solid #ddd;border-radius:10px;background:#fafafa;font-family:sans-serif;text-align:center">';
        echo '<h3>Enter Access Password</h3>';
        echo isset($error) ? $error : '';
        echo '<form method="post"><input type="password" name="sfh_password" placeholder="Password" style="padding:10px;width:100%;margin-bottom:15px;" required>';
        echo '<button type="submit" style="padding:10px 20px;background:#0073aa;color:#fff;border:none;border-radius:5px;">Submit</button></form>';
        echo '</div>';
        get_footer();
        exit;
    }
});

/**
 * STEP 2: After form submission - send PDF to internal team + schedule deletion.
 */
add_action('gform_after_submission', function($entry, $form) {

    $target_form_id = 65; // Your Gravity Form ID
    if ((int)$form['id'] !== $target_form_id) return;

    // Path where Gravity PDF stores files
    $upload_dir = WP_CONTENT_DIR . '/uploads/PDF_EXTENDED_TEMPLATES/';
    $pattern = $upload_dir . '*.pdf';

    // Find the latest generated PDF
    $files = glob($pattern);
    if (!$files) {
        error_log('No Gravity PDF file found.');
        return;
    }

    // Get the most recent file
    usort($files, function($a, $b) {
        return filemtime($b) - filemtime($a);
    });
    $latest_pdf = $files[0];

    // Send to internal recipients
    $internal_emails = [
        'person1@example.com',
        'person2@example.com',
        'person3@example.com',
        'person4@example.com',
        'person5@example.com'
    ];

    $subject = 'New Secure Form Submission (Copy)';
    $message = 'A new form submission was received. The attached PDF contains submission details.';
    $headers = ['Content-Type: text/html; charset=UTF-8'];

    wp_mail($internal_emails, $subject, $message, $headers, [$latest_pdf]);
    error_log('Internal email sent with PDF: ' . $latest_pdf);

    // Schedule file deletion in 10 minutes
    wp_schedule_single_event(time() + 600, 'sfh_delete_temp_pdf', [$latest_pdf]);

}, 20, 2);

/**
 * STEP 3: Delete the PDF file after 10 minutes.
 */
add_action('sfh_delete_temp_pdf', function($pdf_path) {
    if (file_exists($pdf_path)) {
        unlink($pdf_path);
        error_log('Deleted PDF after 10 mins: ' . $pdf_path);
    }
});
